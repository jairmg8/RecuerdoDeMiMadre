<link href="./css/pages/ventas.css" rel="stylesheet"/>
<!-- MÓDULO DE GESTIÓN DE VENTAS -->
<div class="sales-module">
  <div class="container">
    <!-- Estadísticas -->
    <div class="row mb-4">
      <div class="col-md-3 col-sm-6">
        <div class="stats-card bg-primary text-white">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="mb-0">Total Ventas</h6>
              <h3 class="mb-0" id="totalSales">S/0.00</h3>
            </div>
            <i class="bi bi-cash-coin stats-icon"></i>
          </div>
        </div>
      </div>
      <div class="col-md-3 col-sm-6">
        <div class="stats-card bg-success text-white">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="mb-0">Ventas Hoy</h6>
              <h3 class="mb-0" id="todaySales">S/0.00</h3>
            </div>
            <i class="bi bi-graph-up-arrow stats-icon"></i>
          </div>
        </div>
      </div>
      <div class="col-md-3 col-sm-6">
        <div class="stats-card bg-warning text-white">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="mb-0">Pendientes</h6>
              <h3 class="mb-0" id="pendingSales">0</h3>
            </div>
            <i class="bi bi-clock-history stats-icon"></i>
          </div>
        </div>
      </div>
      <div class="col-md-3 col-sm-6">
        <div class="stats-card bg-info text-white">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <h6 class="mb-0">Total Órdenes</h6>
              <h3 class="mb-0" id="totalOrders">0</h3>
            </div>
            <i class="bi bi-cart-check stats-icon"></i>
          </div>
        </div>
      </div>
    </div>

    <!-- Header del módulo -->
    <div class="row mb-4">
      <div class="col-12">
        <h2 class="mb-3"><i class="bi bi-receipt"></i> Gestión de Ventas</h2>
        <div class="card">
          <div class="card-body">
            <div class="row align-items-center">
              <div class="col-md-6 mb-3 mb-md-0">
                <div class="search-box">
                  <i class="bi bi-search"></i>
                  <input
                    type="text"
                    id="searchInput"
                    class="form-control"
                    placeholder="Buscar ventas..."
                  />
                </div>
              </div>
              <div class="col-md-6 text-md-end">
                <button
                  class="btn btn-success"
                  data-bs-toggle="modal"
                  data-bs-target="#saleModal"
                  onclick="openAddModal()"
                >
                  <i class="bi bi-plus-circle"></i> Nueva Venta
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Tabla de ventas -->
    <div class="row">
      <div class="col-12">
        <div class="card">
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-hover" id="salesTable">
                <thead class="table-light">
                  <tr>
                    <th>N° Venta</th>
                    <th>Fecha</th>
                    <th>Cliente</th>
                    <th>Productos</th>
                    <th>Total</th>
                    <th>Estado</th>
                    <th class="text-center">Acciones</th>
                  </tr>
                </thead>
                <tbody id="saleTableBody">
                  <!-- Las ventas se cargan dinámicamente -->
                </tbody>
              </table>
            </div>
            <div
              id="noResults"
              class="text-center text-muted py-4"
              style="display: none"
            >
              <i class="bi bi-inbox" style="font-size: 3rem"></i>
              <p class="mt-2">No se encontraron ventas</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal para Crear/Editar Venta -->
<div class="modal fade" id="saleModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalTitle">Nueva Venta</h5>
        <button
          type="button"
          class="btn-close btn-close-white"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <div class="modal-body">
        <form id="saleForm">
          <input type="hidden" id="saleId" />
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="saleDate" class="form-label">Fecha</label>
              <input type="date" class="form-control" id="saleDate" required />
            </div>
            <div class="col-md-6 mb-3">
              <label for="clientName" class="form-label">Cliente</label>
              <input
                type="text"
                class="form-control"
                id="clientName"
                required
              />
            </div>
          </div>

          <div class="mb-3">
            <label class="form-label">Productos</label>
            <div class="row">
              <div class="col-md-6 mb-2">
                <select class="form-select" id="productSelect">
                  <option value="">Seleccionar producto</option>
                  <option value="Laptop|1200">Medicina natural - S/1,200</option>
                  <option value="Mouse|25">Bebidas - S/25</option>
                  <option value="Teclado|80">Otros - S/80</option>
                  <option value="Monitor|300">Flores - S/300</option>
                  <option value="Auriculares|60">Detalles - S/60</option>
                  <option value="Webcam|90">Webcam - S/90</option>
                </select>
              </div>
              <div class="col-md-3 mb-2">
                <input
                  type="number"
                  class="form-control"
                  id="productQuantity"
                  placeholder="Cantidad"
                  min="1"
                  value="1"
                />
              </div>
              <div class="col-md-3 mb-2">
                <button
                  type="button"
                  class="btn btn-primary w-100"
                  onclick="addProduct()"
                >
                  <i class="bi bi-plus"></i> Agregar
                </button>
              </div>
            </div>
            <div id="productList" class="mt-3">
              <!-- Productos agregados -->
            </div>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="paymentMethod" class="form-label"
                >Método de Pago</label
              >
              <select class="form-select" id="paymentMethod" required>
                <option value="">Seleccionar método</option>
                <option value="Efectivo">Efectivo</option>
                <option value="Tarjeta">Tarjeta</option>
                <option value="Transferencia">Transferencia</option>
              </select>
            </div>
            <div class="col-md-6 mb-3">
              <label for="saleStatus" class="form-label">Estado</label>
              <select class="form-select" id="saleStatus" required>
                <option value="Completada">Completada</option>
                <option value="Pendiente">Pendiente</option>
                <option value="Cancelada">Cancelada</option>
              </select>
            </div>
          </div>

          <div class="bg-light p-3 rounded">
            <h4 class="text-end mb-0">
              Total: $<span id="totalAmount">0.00</span>
            </h4>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Cancelar
        </button>
        <button type="button" class="btn btn-success" onclick="saveSale()">
          Guardar Venta
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal de Detalle de Venta -->
<div class="modal fade" id="detailModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-info text-white">
        <h5 class="modal-title">Detalle de Venta</h5>
        <button
          type="button"
          class="btn-close btn-close-white"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <div class="modal-body" id="detailContent">
        <!-- Contenido del detalle -->
      </div>
    </div>
  </div>
</div>

<!-- Modal de Confirmación para Eliminar -->
<div class="modal fade" id="deleteModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title">Confirmar Eliminación</h5>
        <button
          type="button"
          class="btn-close btn-close-white"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <div class="modal-body">
        <p>¿Estás seguro de que deseas eliminar esta venta?</p>
        <p class="text-muted mb-0">Esta acción no se puede deshacer.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Cancelar
        </button>
        <button type="button" class="btn btn-danger" id="confirmDelete">
          Eliminar
        </button>
      </div>
    </div>
  </div>
</div>
<script>
  // Datos de ventas (simulación)
let sales = [
  {
    id: 1,
    date: "2025-09-30",
    client: "María González",
    products: [{ name: "Laptop", quantity: 1, price: 1200 }],
    paymentMethod: "Tarjeta",
    total: 1200,
    status: "Completada",
  },
  {
    id: 2,
    date: "2025-09-29",
    client: "Carlos Ruiz",
    products: [
      { name: "Mouse", quantity: 2, price: 25 },
      { name: "Teclado", quantity: 1, price: 80 },
    ],
    paymentMethod: "Efectivo",
    total: 130,
    status: "Completada",
  },
  {
    id: 3,
    date: "2025-09-28",
    client: "Ana Torres",
    products: [{ name: "Monitor", quantity: 1, price: 300 }],
    paymentMethod: "Transferencia",
    total: 300,
    status: "Pendiente",
  },
];

let editingId = null;
let deleteId = null;
let currentProducts = [];

// Renderizar tabla
function renderSales(filteredSales = sales) {
  const tbody = document.getElementById("saleTableBody");
  const noResults = document.getElementById("noResults");

  if (filteredSales.length === 0) {
    tbody.innerHTML = "";
    noResults.style.display = "block";
    return;
  }

  noResults.style.display = "none";
  tbody.innerHTML = filteredSales
    .map(
      (sale) => `
                <tr>
                    <td><strong>#${String(sale.id).padStart(
                      4,
                      "0"
                    )}</strong></td>
                    <td>${formatDate(sale.date)}</td>
                    <td><i class="bi bi-person"></i> ${sale.client}</td>
                    <td>${sale.products.length} producto(s)</td>
                    <td><strong>$${sale.total.toFixed(2)}</strong></td>
                    <td>
                        <span class="badge ${getStatusBadge(
                          sale.status
                        )} badge-status">
                            ${sale.status}
                        </span>
                    </td>
                    <td class="text-center">
                        <button class="btn btn-sm btn-info btn-action" onclick="viewDetail(${
                          sale.id
                        })" title="Ver detalle">
                            <i class="bi bi-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-warning btn-action" onclick="editSale(${
                          sale.id
                        })" title="Editar">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-danger btn-action" onclick="deleteSale(${
                          sale.id
                        })" title="Eliminar">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
            `
    )
    .join("");

  updateStats();
}

// Actualizar estadísticas
function updateStats() {
  const today = new Date().toISOString().split("T")[0];
  const totalAmount = sales.reduce((sum, sale) => sum + sale.total, 0);
  const todayAmount = sales
    .filter((s) => s.date === today)
    .reduce((sum, sale) => sum + sale.total, 0);
  const pending = sales.filter((s) => s.status === "Pendiente").length;

  document.getElementById("totalSales").textContent = `$${totalAmount.toFixed(
    2
  )}`;
  document.getElementById("todaySales").textContent = `$${todayAmount.toFixed(
    2
  )}`;
  document.getElementById("pendingSales").textContent = pending;
  document.getElementById("totalOrders").textContent = sales.length;
}

function getStatusBadge(status) {
  const badges = {
    Completada: "bg-success",
    Pendiente: "bg-warning",
    Cancelada: "bg-danger",
  };
  return badges[status] || "bg-secondary";
}

function formatDate(dateStr) {
  const date = new Date(dateStr + "T00:00:00");
  return date.toLocaleDateString("es-ES", {
    day: "2-digit",
    month: "2-digit",
    year: "numeric",
  });
}

// Búsqueda
document.getElementById("searchInput").addEventListener("input", function (e) {
  const search = e.target.value.toLowerCase();
  const filtered = sales.filter(
    (sale) =>
      sale.client.toLowerCase().includes(search) ||
      sale.id.toString().includes(search) ||
      sale.status.toLowerCase().includes(search)
  );
  renderSales(filtered);
});

// Agregar producto al listado
function addProduct() {
  const select = document.getElementById("productSelect");
  const quantity =
    parseInt(document.getElementById("productQuantity").value) || 1;

  if (!select.value) {
    alert("Selecciona un producto");
    return;
  }

  const [name, price] = select.value.split("|");
  currentProducts.push({ name, quantity, price: parseFloat(price) });

  renderProductList();
  select.value = "";
  document.getElementById("productQuantity").value = 1;
}

function renderProductList() {
  const list = document.getElementById("productList");
  const total = currentProducts.reduce(
    (sum, p) => sum + p.price * p.quantity,
    0
  );

  list.innerHTML = currentProducts
    .map(
      (p, index) => `
                <div class="product-item d-flex justify-content-between align-items-center">
                    <div>
                        <strong>${p.name}</strong> x ${p.quantity}
                        <span class="text-muted">($${p.price} c/u)</span>
                    </div>
                    <div>
                        <span class="me-3"><strong>$${(
                          p.price * p.quantity
                        ).toFixed(2)}</strong></span>
                        <button type="button" class="btn btn-sm btn-danger" onclick="removeProduct(${index})">
                            <i class="bi bi-x"></i>
                        </button>
                    </div>
                </div>
            `
    )
    .join("");

  document.getElementById("totalAmount").textContent = total.toFixed(2);
}

function removeProduct(index) {
  currentProducts.splice(index, 1);
  renderProductList();
}

// Abrir modal para agregar
function openAddModal() {
  editingId = null;
  currentProducts = [];
  document.getElementById("modalTitle").textContent = "Nueva Venta";
  document.getElementById("saleForm").reset();
  document.getElementById("saleId").value = "";
  document.getElementById("saleDate").value = new Date()
    .toISOString()
    .split("T")[0];
  document.getElementById("productList").innerHTML = "";
  document.getElementById("totalAmount").textContent = "0.00";
}

// Ver detalle
function viewDetail(id) {
  const sale = sales.find((s) => s.id === id);
  const content = `
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <strong>N° Venta:</strong> #${String(sale.id).padStart(
                          4,
                          "0"
                        )}
                    </div>
                    <div class="col-md-6 mb-3">
                        <strong>Fecha:</strong> ${formatDate(sale.date)}
                    </div>
                    <div class="col-md-6 mb-3">
                        <strong>Cliente:</strong> ${sale.client}
                    </div>
                    <div class="col-md-6 mb-3">
                        <strong>Método de Pago:</strong> ${sale.paymentMethod}
                    </div>
                </div>
                <hr>
                <h6>Productos:</h6>
                ${sale.products
                  .map(
                    (p) => `
                    <div class="product-item">
                        ${p.name} x ${p.quantity} - $${
                      p.price
                    } c/u = <strong>$${(p.price * p.quantity).toFixed(
                      2
                    )}</strong>
                    </div>
                `
                  )
                  .join("")}
                <hr>
                <h4 class="text-end">Total: $${sale.total.toFixed(2)}</h4>
                <div class="text-end">
                    <span class="badge ${getStatusBadge(
                      sale.status
                    )} badge-status">${sale.status}</span>
                </div>
            `;

  document.getElementById("detailContent").innerHTML = content;
  new bootstrap.Modal(document.getElementById("detailModal")).show();
}

// Editar venta
function editSale(id) {
  editingId = id;
  const sale = sales.find((s) => s.id === id);

  document.getElementById("modalTitle").textContent = "Editar Venta";
  document.getElementById("saleId").value = sale.id;
  document.getElementById("saleDate").value = sale.date;
  document.getElementById("clientName").value = sale.client;
  document.getElementById("paymentMethod").value = sale.paymentMethod;
  document.getElementById("saleStatus").value = sale.status;

  currentProducts = [...sale.products];
  renderProductList();

  new bootstrap.Modal(document.getElementById("saleModal")).show();
}

// Guardar venta
function saveSale() {
  const form = document.getElementById("saleForm");
  if (!form.checkValidity()) {
    form.reportValidity();
    return;
  }

  if (currentProducts.length === 0) {
    alert("Agrega al menos un producto");
    return;
  }

  const saleData = {
    date: document.getElementById("saleDate").value,
    client: document.getElementById("clientName").value,
    products: currentProducts,
    paymentMethod: document.getElementById("paymentMethod").value,
    total: currentProducts.reduce((sum, p) => sum + p.price * p.quantity, 0),
    status: document.getElementById("saleStatus").value,
  };

  if (editingId) {
    const index = sales.findIndex((s) => s.id === editingId);
    sales[index] = { ...sales[index], ...saleData };
  } else {
    const newId = Math.max(...sales.map((s) => s.id), 0) + 1;
    sales.push({ id: newId, ...saleData });
  }

  renderSales();
  bootstrap.Modal.getInstance(document.getElementById("saleModal")).hide();
  form.reset();
  currentProducts = [];
}

// Eliminar venta
function deleteSale(id) {
  deleteId = id;
  const modal = new bootstrap.Modal(document.getElementById("deleteModal"));
  modal.show();
}

document.getElementById("confirmDelete").addEventListener("click", function () {
  sales = sales.filter((s) => s.id !== deleteId);
  renderSales();
  bootstrap.Modal.getInstance(document.getElementById("deleteModal")).hide();
});

// Inicializar
renderSales();

</script>